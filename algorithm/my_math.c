#include <math.h>
#include "algo_config.h"
void cross3(float pSrcA[3], float pSrcB[3], float pDst[3])
{
    pDst[0] = pSrcA[1] * pSrcB[2] - pSrcA[2] * pSrcB[1];
    pDst[1] = pSrcA[2] * pSrcB[0] - pSrcA[0] * pSrcB[2];
    pDst[2] = pSrcA[0] * pSrcB[1] - pSrcA[1] * pSrcB[0];
}

void dot3(float pSrcA[3], float pSrcB[3], float pDst[1])
{
    pDst[0] = pSrcA[0] * pSrcB[0] + pSrcA[1] * pSrcB[1] + pSrcA[2] * pSrcB[2];
}

void scale3(float pSrc[3], float scale, float pDst[3])
{
    pDst[0] = pSrc[0] * scale;
    pDst[1] = pSrc[1] * scale;
    pDst[2] = pSrc[2] * scale;
}

float sqrt_carmack(float number)
{
    int i;
    float x2, y;
    const float threehalfs = 1.5F;

    x2 = number * 0.5F;
    y = number;
    i = *(int *)&y;
    i = 0x5f375a86 - (i >> 1);
    y = *(float *)&i;
    y = y * (threehalfs - (x2 * y * y));
    y = y * (threehalfs - (x2 * y * y));
    y = y * (threehalfs - (x2 * y * y));
    return number * y;
}

float inv_sqrt_carmack(float number)
{
    int32_t i;
    float x2, y;
    const float threehalfs = 1.5F;

    x2 = number * 0.5F;
    y = number;
    i = *(int32_t *)&y;
    i = 0x5f375a86 - (i >> 1);
    y = *(float *)&i;
    y = y * (threehalfs - (x2 * y * y));
    y = y * (threehalfs - (x2 * y * y));
    y = y * (threehalfs - (x2 * y * y));
    return y;
}

float sqrt_newton(float x)
{
    int temp = (((*(int *)&x) & 0xff7fffff) >> 1) + (64 << 23);
    float val = *(float *)&temp;
    float last;
    do {
        last = val;
        val = (val + x / val) / 2;
    } while (fabsf(val - last) > 0.00001);
    return val;
}

void normalize3(float pSrc[3], float pDst[3])
{
    float square = 0;
    dot3(pSrc, pSrc, &square);

    float norm = inv_sqrt_carmack(square);

    pDst[0] = pSrc[0] * norm;
    pDst[1] = pSrc[1] * norm;
    pDst[2] = pSrc[2] * norm;
}

#define PI_2 1.570796326794897
const float asin_Y[101] = {0.0000000000000000, 0.0100001664832234, 0.0200013332068920, 0.0300045013427734, 0.0400106720626354, 0.0500208586454391, 0.0600360557436943, 0.0700572952628136, 0.0800855755805969, 0.0901219472289085, 0.1001674234867096, 0.1102230474352837, 0.1202898770570755, 0.1303689777851105, 0.1404614150524139, 0.1505682766437531, 0.1606906503438950, 0.1708296686410904, 0.1809864640235901, 0.1911621391773224, 0.2013579308986664, 0.2115749567747116, 0.2218144685029984, 0.2320776879787445, 0.2423658519983292, 0.2526802420616150, 0.2630221843719482, 0.2733930349349976, 0.2837941050529480, 0.2942268252372742, 0.3046926558017731, 0.3151930272579193, 0.3257294893264771, 0.3363035917282105, 0.3469169139862061, 0.3575710952281952, 0.3682678937911987, 0.3790090382099152, 0.3897962868213654, 0.4006315767765045, 0.4115168452262878, 0.4224540591239929, 0.4334453046321869, 0.4444927871227264, 0.4555986821651459, 0.4667653143405914, 0.4779952168464661, 0.4892907738685608, 0.5006546974182129, 0.5120897889137268, 0.5235987901687622, 0.5351847410202026, 0.5468509197235107, 0.5586005449295044, 0.5704371333122253, 0.5823642611503601, 0.5943858027458191, 0.6065058708190918, 0.6187286376953125, 0.6310588121414185, 0.6435011625289917, 0.6560605764389038, 0.6687427163124085, 0.6815531849861145, 0.6944982409477234, 0.7075843811035156, 0.7208188176155090, 0.7342088222503662, 0.7477626204490662, 0.7614890336990356, 0.7753974795341492, 0.7894981503486633, 0.8038023710250855, 0.8183220028877258, 0.8330703973770142, 0.8480620980262756, 0.8633130788803101, 0.8788411021232605, 0.8946657776832581, 0.9108090400695801, 0.9272952079772949, 0.9441521167755127, 0.9614109992980957, 0.9791076183319092, 0.9972831606864929, 1.0159853696823120, 1.0352697372436523, 1.0552023649215698, 1.0758621692657471, 1.0973451137542725, 1.1197694540023804, 1.1432840824127197, 1.1680805683135986, 1.1944128274917603, 1.2226302623748779, 1.2532358169555664, 1.2870020866394043, 1.3252309560775757, 1.3704615831375122, 1.4292569160461426, 1.5707963705062866};
const float atan2_Y_0_20[101] = {0.0000000000000000, 0.1973955598498808, 0.3805063771123649, 0.5404195002705843, 0.6747409422235527, 0.7853981633974483, 0.8760580505981935, 0.9505468408120752, 1.0121970114513341, 1.0636978224025597, 1.1071487177940904, 1.1441688336680205, 1.1760052070951352, 1.2036224929766774, 1.2277723863741934, 1.2490457723982544, 1.2679114584199251, 1.2847448850775784, 1.2998494764564761, 1.3134726118238080, 1.3258176636680326, 1.3370531459259951, 1.3473197256542635, 1.3567356432310751, 1.3654009376051293, 1.3734007669450159, 1.3808080388761810, 1.3876855095324125, 1.3940874707248601, 1.4000611153196139, 1.4056476493802699, 1.4108832036366774, 1.4157995848709557, 1.4204248987877621, 1.4247840690836213, 1.4288992721907328, 1.4327903031373772, 1.4364748848419282, 1.4399689307208396, 1.4432867685796584, 1.4464413322481351, 1.4494443262241330, 1.4523063676367589, 1.4550371090740859, 1.4576453452044120, 1.4601391056210009, 1.4625257359344406, 1.4648119688052967, 1.4670039863378539, 1.4691074750318196, 1.4711276743037347, 1.4730694194361780, 1.4749371796848834, 1.4767350921669102, 1.4784669920632976, 1.4801364395941514, 1.4817467441603989, 1.4833009859925053, 1.4848020356006559, 1.4862525712818986, 1.4876550949064553, 1.4890119461769007, 1.4903253155294358, 1.4915972558254451, 1.4928296929633542, 1.4940244355251187, 1.4951831835580667, 1.4963075365810148, 1.4973990008932849, 1.4984589962563017, 1.4994888620096063, 1.5004898626762722, 1.5014631931066880, 1.5024099832043931, 1.5033313022729919, 1.5042281630190728, 1.5051015252424318, 1.5059522992416898, 1.5067813489605526, 1.5075894948974364, 1.5083775167989393, 1.5091461561556376, 1.5098961185169086, 1.5106280756398869, 1.5113426674862398, 1.5120405040791740, 1.5127221672319426, 1.5133882121580970, 1.5140391689728032, 1.5146755440937201, 1.5152978215491797, 1.5159064642007427, 1.5165019148865906, 1.5170845974916640, 1.5176549179499612, 1.5182132651839548, 1.5187600119856803, 1.5192955158436712, 1.5198201197195833, 1.5203341527780407, 1.5208379310729538};
const float atan2_Y_20_200[101] = {1.5208379310729538, 1.5249569009137798, 1.5284487777743208, 1.5314465704062914, 1.5340481717519010, 1.5363272257953886, 1.5383401955658773, 1.5401310958679479, 1.5417347436860835, 1.5431790409133543, 1.5444866095419745, 1.5456759838985445, 1.5467624938411391, 1.5477589284884403, 1.5486760415661411, 1.5495229407708355, 1.5503073910588083, 1.5510360532677201, 1.5517146736035938, 1.5523482354037401, 1.5529410816553442, 1.5534970146390252, 1.5540193775292834, 1.5545111216515508, 1.5549748622533230, 1.5554129250143014, 1.5558273850412261, 1.5562200997268940, 1.5565927365708845, 1.5569467968407540, 1.5572836357815685, 1.5576044799472373, 1.5579104421207641, 1.5582025342058488, 1.5584816784044950, 1.5587487169407106, 1.5590044205462408, 1.5592494958883882, 1.5594845920906490, 1.5597103064728477, 1.5599271896176263, 1.5601357498537516, 1.5603364572330740, 1.5605297470666282, 1.5607160230758490, 1.5608956602069080, 1.5610690071494504, 1.5612363885953275, 1.5613981072681120, 1.5615544457500772, 1.5617056681298369, 1.5618520214908538, 1.5619937372584611, 1.5621310324208424, 1.5622641106375186, 1.5623931632472496, 1.5625183701858421, 1.5626399008231175, 1.5627579147272304, 1.5628725623635853, 1.5629839857347956, 1.5630923189673964, 1.5631976888504207, 1.5633002153303728, 1.5634000119666731, 1.5634971863511995, 1.5635918404951907, 1.5636840711864339, 1.5637739703193643, 1.5638616252004454, 1.5639471188309615, 1.5640305301691493, 1.5641119343734062, 1.5641914030281525, 1.5642690043537724, 1.5643448034019281, 1.5644188622374231, 1.5644912401076825, 1.5645619936008215, 1.5646311767931926, 1.5646988413872147, 1.5647650368402257, 1.5648298104850347, 1.5648932076427846, 1.5649552717287010, 1.5650160443512349, 1.5650755654050841, 1.5651338731585238, 1.5651910043354529, 1.5652469941925207, 1.5653018765916802, 1.5653556840684761, 1.5654084478963608, 1.5654601981473033, 1.5655109637489393, 1.5655607725384890, 1.5656096513136566, 1.5656576258807027, 1.5657047210998751, 1.5657509609283644, 1.5657963684609384};

float asin_piecewise(float x)
{
    float x_ans, y;
    unsigned short index_c_low, index_c_high;

    if (x >= 1)
        return PI_2;
    else if (x <= -1)
        return -PI_2;

    if (x >= 0)
        x_ans = x;
    else
        x_ans = -x;

    if (x_ans != 1.0) {
        index_c_low = floor(x_ans * 100);
        index_c_high = index_c_low + 1;
        y = (x_ans - ((float)(index_c_low)) / 100) * (asin_Y[index_c_high] - asin_Y[index_c_low]) / 0.01 + asin_Y[index_c_low];
    } else
        y = PI_2;
    if (x < 0)
        y = -y;
    return y;
}

float atan2_piecewise(float y, float x)
{
    float y_d_x, x_ans, final = 0;
    unsigned short index_c_low, index_c_high;

    if (x == 0)
        return PI_2;

    y_d_x = y / x;
    if (y_d_x >= 0)
        x_ans = y_d_x;
    else
        x_ans = -y_d_x;

    if (x_ans == 20)
        final = 1.520837931072954;
    else if (x_ans < 20) {
        index_c_low = floor(x_ans * 5);
        index_c_high = index_c_low + 1;
        final = (x_ans - index_c_low * 0.2) * (atan2_Y_0_20[index_c_high] - atan2_Y_0_20[index_c_low]) * 5 + atan2_Y_0_20[index_c_low];
    } else if (x_ans >= 200)
        final = 1.565796368460938;
    else if (x_ans < 200) {
        index_c_low = floor((x_ans - 20) / 1.8);
        index_c_high = index_c_low + 1;
        final = (x_ans - index_c_low * 1.8 - 20) * (atan2_Y_20_200[index_c_high] - atan2_Y_20_200[index_c_low]) / 1.8 + atan2_Y_20_200[index_c_low];
    }

    if (y_d_x < 0)
        final = -final;

    if (x < 0) {
        if (y == 0)
            final = 0;
        else if (y > 0)
            final = final + 3.141592653589793;
        else
            final = final - 3.141592653589793;
    }
    return final;
}